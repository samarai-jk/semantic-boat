# STM32 project structure (CubeMX-friendly)

This project keeps all application logic outside of CubeMX-generated files. Only minimal calls live in `Core/Src/main.c` inside USER CODE regions.

## Folders
- Core/Inc, Core/Src: Generated by CubeMX. Do not modify outside USER CODE regions.
- App/: Application entry points and orchestration (your code). Add more modules as needed.
- Drivers/: HAL and CMSIS (generated).

A common layering you can follow as the project grows:
- App/            — startup, main loop, state machines (e.g., `app_init()`, `app_step()`).
- BSP/            — board/pin helpers (LEDs, relays, PWM, ADC routing).
- Services/       — reusable services (debounce, scheduler, PID, filters, I2C/SMBus helper).
- Middleware/     — protocols or stacks if you add any.

You can place `BSP/`, `Services/`, `Middleware/` next to `App/`. Update the Makefile to compile them and add `-I` include paths.

## Contract for main.c
- Include `app.h` inside `/* USER CODE BEGIN Includes */`.
- After CubeMX peripheral init, call `app_init()` inside `/* USER CODE BEGIN 2 */`.
- In the main while loop, call `app_step()` inside `/* USER CODE BEGIN WHILE */`.

All real work happens in App and friends.

## Interrupts and callbacks
Keep `stm32f3xx_it.c` as generated. Implement logic in your code and call it from weak callbacks:
- HAL weak callbacks (e.g., `HAL_TIM_PeriodElapsedCallback`) — forward to your module.
- EXTI/IRQ handlers — keep handler signatures in `*_it.c` but immediately call your code in another file.

## HAL handles access
If a module needs a peripheral handle (e.g., `htim4`), either:
- Include `main.h` and declare `extern TIM_HandleTypeDef htim4;`, or
- Create thin BSP wrappers (preferred as project grows), e.g., `bsp_pwm_set(TIM4, CH3, duty)` to avoid leaking HAL details.

## Regeneration notes (CubeMX)
CubeMX may overwrite `Makefile`. If that happens, re-add:
- `App/app.c` to `C_SOURCES`
- `-IApp` to `C_INCLUDES`

Alternatively, keep a small patch script or migrate to a CMake wrapper that includes generated sources plus your folders.

## Current wiring
- `App/app.c` implements a simple PWM ramp on TIM4 CH3.
- `Core/Src/main.c` calls `app_init()` and `app_step()` within USER CODE blocks.

## Build
Use the provided Makefile:

```pwsh
make -C "d:\\Projects\\Private\\Sailing\\semantic-boat\\smart-stack\\smart-switch\\stm32"
```

If CubeMX regenerates code, revisit the Makefile edits described above.
